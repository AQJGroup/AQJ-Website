<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <!-- Make sure viewport is correct for mobile -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.2, viewport-fit=cover" />
  <title>AQJ Group — Engineering | BIM | Digital Delivery</title>

  <!-- Favicons (use root absolute paths so every page and browser finds them) -->
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon.png">
  <link rel="icon" type="image/x-icon" href="/favicon.ico">
  <link rel="apple-touch-icon" href="/favicon.png">
  <meta name="msapplication-TileImage" content="/favicon.png">

  <!-- Styles -->
  <link rel="stylesheet" href="../css/styles.css" />
  <meta name="description" content="AQJ Group — BIM, model coordination, digital twin & construction technology." />

  <!-- Fonts (kept) -->
  <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@700&family=Poppins:wght@400;600&display=swap" rel="stylesheet">

  <style>
    /* ---------- NAVBAR (unchanged) ---------- */
    .navbar { padding-top: 8px; padding-bottom: 8px; }
    .nav-inner { align-items: center; gap: 18px; }
    .brand .logo, .logo { height: 56px; width: auto; display: block; }
    .nav a { display:inline-block;padding:6px 12px;text-decoration:none; }

    /* ====== Robust Marquee: No clipping on Arabic ====== */
    :root {
      --duration: 18s;  /* total travel time — lower = faster */
      --gap: 26px;      /* gap between runs */
    }

    /* Top marquee base (dark default) */
    .top-marquee {
      width:100%;
      height:56px;
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
      position:relative;
      background: linear-gradient(90deg, rgba(8,8,8,0.72), rgba(12,12,12,0.55));
      border-bottom:1px solid rgba(255,255,255,0.06);
      padding:0 12px;
      z-index:105; /* placed above header (header uses z-index:90) */
      box-sizing:border-box;
      backdrop-filter: blur(4px);
      margin-top: -14px; /* small negative offset to pull the bar upward */
      pointer-events: none; /* allow clicks to pass through except on pills */
    }

    /* Make marquee theme-aware for light mode */
    html[data-theme="light"] .top-marquee,
    html.light .top-marquee,
    html.light-theme .top-marquee {
      background: linear-gradient(90deg, rgba(255,255,255,0.95), rgba(250,250,250,0.9));
      border-bottom:1px solid rgba(0,0,0,0.06);
    }

    /* runner wrapper: absolute so items can travel full width */
    .runner {
      position:absolute;
      top:50%;
      left:0;
      transform:translateY(-50%);
      pointer-events:none;
      white-space:nowrap;
      animation: runnerTravel var(--duration) linear infinite;
      will-change: transform, opacity;
    }

    /* second runner staggered so there is always a pill in motion */
    .runner.runner-2 { animation-delay: calc(var(--duration) / -2); }

    /* pill appearance (no clipping on text) */
    .marquee-pill {
      display:inline-flex;
      align-items:center;
      gap:12px;
      padding:8px 36px;
      border-radius:999px;
      /* default dark-style pill, light-mode override below */
      background: rgba(255,255,255,0.04);
      box-shadow: 0 6px 18px rgba(0,0,0,0.45) inset;
      color:#fff;
      font-family: "Amiri", serif;
      font-weight:700;
      font-size:1.08rem;
      line-height:1;
      text-align:center;
      transform: translateZ(0); /* force GPU layer for smoothness */
      will-change: transform, opacity;
      opacity: 1; /* ensure visible */
      pointer-events: auto; /* allow interacting with pill if needed */
    }

    /* Light-theme pill override */
    html[data-theme="light"] .marquee-pill,
    html.light .marquee-pill,
    html.light-theme .marquee-pill {
      background: rgba(0,0,0,0.06);
      box-shadow: 0 6px 18px rgba(0,0,0,0.06);
      color: #111;
    }

    .marquee-pill .trans {
      font-family: "Poppins", sans-serif;
      font-size:0.82rem;
      color: rgba(255,255,255,0.92);
      margin-left:12px;
      white-space: nowrap;
    }

    /* make translation text darker in light theme */
    html[data-theme="light"] .marquee-pill .trans,
    html.light .marquee-pill .trans,
    html.light-theme .marquee-pill .trans {
      color: rgba(0,0,0,0.7);
    }

    /* UNIFORM MOVEMENT: constant linear speed from off-right -> off-left */
    @keyframes runnerTravel {
      0% {
        transform: translateX(calc(100vw)) translateY(-50%);
      }
      100% {
        transform: translateX(calc(-100% - 100vw)) translateY(-50%);
      }
    }

    /* gentle fade in/out only (no positional acceleration) */
    @keyframes pillOpacity {
      0% { opacity: 0; }
      10% { opacity: 1; }
      90% { opacity: 1; }
      100% { opacity: 0; }
    }

    /* Apply opacity animation on the pill via animation shorthand with matching timing */
    .runner .marquee-pill {
      animation: pillOpacity var(--duration) linear infinite;
      animation-fill-mode: both;
    }
    .runner.runner-2 .marquee-pill { animation-delay: calc(var(--duration) / -2); }

    /* soft fade masks at edges */
    .top-marquee::before,
    .top-marquee::after {
      content: "";
      position: absolute;
      top: 0; bottom: 0; width: 6%;
      pointer-events: none; z-index: 110;
    }
    .top-marquee::before { left: 0; background: linear-gradient(to right, rgba(8,8,8,1), rgba(8,8,8,0)); }
    .top-marquee::after  { right:0; background: linear-gradient(to left, rgba(8,8,8,1), rgba(8,8,8,0)); }

    /* light-mode masks */
    html[data-theme="light"] .top-marquee::before,
    html[data-theme="light"] .top-marquee::after,
    html.light .top-marquee::before,
    html.light .top-marquee::after,
    html.light-theme .top-marquee::before,
    html.light-theme .top-marquee::after {
      background: linear-gradient(to right, rgba(255,255,255,0.95), rgba(255,255,255,0));
    }

    /* pause on hover for readability */
    .top-marquee:hover .runner,
    .top-marquee:hover .runner .marquee-pill { animation-play-state: paused; }

    @media (max-width:900px) {
      :root { --duration: 14s; }
      .top-marquee { height:52px; padding: 0 8px; }
      .marquee-pill { padding:6px 18px; font-size:1rem; }
      .marquee-pill .trans { font-size:0.75rem; margin-left:8px; }
    }

    /* Small helper class for mobile menu button placed in header (injected via JS) */
    .mobile-menu-btn {
      display: none;
      background: transparent;
      border: 1px solid rgba(255,255,255,0.08);
      color: var(--text);
      padding: 8px 10px;
      border-radius: 8px;
      font-size: 20px;
      line-height:1;
      cursor: pointer;
    }
    @media (max-width:900px) {
      .mobile-menu-btn { display:inline-flex; align-items:center; justify-content:center; min-width:44px; min-height:44px; }
      /* hide the desktop nav by default on small screens; will be toggled by JS */
      .site-header .nav { display: none !important; }
      .site-header .nav.mobile-open {
        display: flex !important;
        flex-direction: column;
        gap: 12px;
        position: absolute;
        left: 12px;
        right: 12px;
        top: calc(100% + 8px);
        padding: 12px;
        background: var(--surface);
        border-radius: 10px;
        box-shadow: 0 12px 30px rgba(0,0,0,0.28);
      }
      /* ensure nav links are tappable */
      .site-header .nav.mobile-open a { padding: 10px 12px; display:block; border-radius:6px; }
    }

    /* ------------------ ADDED RULES (for your requests) ------------------ */
    /* 1) Increase logo size by 1.5% (using site's --logo-height) */
    .site-header .logo img {
      /* multiply the base logo height by 1.015 to increase by 1.5% */
      height: calc(var(--logo-height) * 1.015) !important;
      max-height: calc(var(--logo-height) * 1.4) !important;
    }

    /* 2) Center-align the header content: logo and nav are centered horizontally */
    /* These selectors are intentionally scoped to .site-header so they won't change other pages. */
    .site-header {
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      z-index: 100; /* ensure header sits beneath marquee (marquee z-index is 105) */
    }
    /* ensure brand (logo) and nav sit centered */
    .site-header .brand,
    .site-header .nav {
      margin: 0 auto;
      display: flex;
      align-items: center;
    }
    /* center nav entries horizontally and keep spacing */
    .site-header .nav {
      justify-content: center;
      gap: 22px;
    }

    /* 3) Move the top-marquee upward (already given small negative margin above),
       and also nudge the hero up so it fills that blank space */
    .hero {
      /* small upward offset so the hero banner sits closer to the header + marquee */
      margin-top: -12px;
      /* ensure hero still has the same visual stacking */
      z-index: 0;
    }

    /* Minor tweak: reduce header bottom padding to tighten the header area */
    .site-header {
      padding-bottom: 8px; /* tightened from default */
    }

    /* Keep desktop layout stable; mobile adjustments remain handled by existing media queries */
    @media (max-width:900px) {
      /* avoid overlapping on small screens */
      .top-marquee { margin-top: 0; }
      .hero { margin-top: 0; }
      .site-header .logo img { height: calc(var(--logo-height) * 1.02) !important; }
    }
    /* ---------------- end of added rules ------------------ */

  </style>
</head>

<body data-page="home">

  <!-- Header (auto-injected) -->
  <div id="header-placeholder"></div>

  <!-- Simple robust marquee (no glyph clipping) -->
  <div class="top-marquee" role="region" aria-label="Scrolling Qur'anic verse">
    <div class="runner runner-1" aria-hidden="true">
      <div class="marquee-pill">
        <span class="arabic" lang="ar" dir="rtl">رَبِّ زِدْنِي عِلْمًا</span>
        <span class="trans">“My Lord, increase me in knowledge.” — Taha 20:114</span>
      </div>
    </div>

    <div class="runner runner-2" aria-hidden="true">
      <div class="marquee-pill">
        <span class="arabic" lang="ar" dir="rtl">رَبِّ زِدْنِي عِلْمًا</span>
        <span class="trans">“My Lord, increase me in knowledge.” — Taha 20:114</span>
      </div>
    </div>
  </div>

  <!-- HERO -->
  <section class="hero" aria-label="Hero">
    <video class="hero-video" autoplay muted loop playsinline poster="../assets/images/projects/project01/thumb.jpg">
      <source src="../assets/videos/hero.mp4" type="video/mp4">
    </video>

    <div class="hero-content container">
      <div class="hero-inner" style="max-width:980px;margin:0 auto;text-align:center">
        <h1 style="font-size:34px;line-height:1.1;margin:0 0 8px;">Transforming Construction Through Digital Innovation</h1>
        <p style="color:var(--muted);margin:0 0 18px;">
          We deliver precision, efficiency and actionable asset data across design, build and operations using BIM and Digital Twin workflows.
        </p>
        <div style="display:flex;gap:12px;justify-content:center;flex-wrap:wrap;margin-top:10px;">
          <a class="btn primary" href="contact.html">Get a Quote</a>
          <a class="btn outline" href="projects.html">Explore Projects</a>
        </div>
      </div>
    </div>
  </section>

  <!-- ===== IFC VIEWER SECTION (moved inside body, before footer) ===== -->
  <section id="ifc-section" class="container" style="padding:30px 20px;">
    <h2 style="margin:0 0 12px;text-align:center;">Interactive IFC Viewer</h2>
    <p style="color:var(--muted);text-align:center;margin:0 0 18px;max-width:920px;margin-left:auto;margin-right:auto;">
      Load an IFC model to view, rotate, zoom and inspect. Use the controls below to load from a URL or your local machine.
    </p>

    <div style="display:flex;gap:12px;align-items:center;justify-content:center;margin-bottom:12px;flex-wrap:wrap;">
      <label style="display:inline-flex;align-items:center;gap:8px;">
        <input id="ifcFileInput" type="file" accept=".ifc" style="display:inline-block" />
        <span style="font-weight:600;color:var(--muted);font-size:0.95rem;">Open local IFC</span>
      </label>

      <div style="display:flex;gap:8px;align-items:center;">
        <input id="ifcUrlInput" placeholder="Paste IFC URL (http(s)://.../model.ifc)" style="min-width:360px;padding:8px;border-radius:6px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:var(--text)">
        <button id="ifcLoadUrlBtn" class="btn" style="padding:8px 12px;">Load URL</button>
      </div>

      <button id="ifcFitBtn" class="btn" style="padding:8px 12px;">Fit to view</button>
      <button id="ifcWireBtn" class="btn" style="padding:8px 12px;">Toggle edges</button>
      <button id="ifcBgBtn" class="btn" style="padding:8px 12px;">Toggle bg</button>
    </div>

    <!-- viewer container -->
    <div id="ifc-viewer-container" style="width:100%;height:520px;border-radius:12px;overflow:hidden;border:1px solid rgba(255,255,255,0.04);box-shadow:0 10px 30px rgba(0,0,0,0.35);"></div>

    <div style="margin-top:8px;color:var(--muted);font-size:0.9rem;text-align:center;">
      Tip: Left-drag rotate, right-drag (or two-finger) pan, wheel/pinch to zoom. Click an element to isolate it.
    </div>
  </section>
  <!-- ===== end IFC section ===== -->

  <!-- Footer -->
  <div id="footer-placeholder"></div>

  <!-- Scripts (keep includes) -->
  <script src="include-partials.js" defer></script>
  <script src="../js/app.js" defer></script>

  <!-- web-ifc-viewer + three.js via CDN (UMD builds) - must be loaded before viewer init -->
  <!-- NOTE: replaced web-ifc-viewer include with an unpkg UMD build that exports IfcViewerAPI -->
  <script src="https://unpkg.com/three@0.154.0/build/three.min.js" crossorigin="anonymous"></script>
  <script src="https://unpkg.com/web-ifc-viewer/dist/index.umd.js" crossorigin="anonymous"></script>

  <script>
    (function () {
      // utility to wait for an element to appear (used for header injection)
      function waitFor(selector, timeout = 3000) {
        return new Promise((resolve, reject) => {
          const el = document.querySelector(selector);
          if (el) return resolve(el);
          const obs = new MutationObserver(() => {
            const e = document.querySelector(selector);
            if (e) {
              obs.disconnect();
              resolve(e);
            }
          });
          obs.observe(document.documentElement, { childList: true, subtree: true });
          setTimeout(() => {
            obs.disconnect();
            reject(new Error('timeout waiting for ' + selector));
          }, timeout);
        });
      }

      // After DOM and header injection
      document.addEventListener('DOMContentLoaded', function () {
        // wait for header (element created by include-partials.js). Try a few sensible selectors:
        const headerSelectors = ['.site-header', '#header', '#siteHeader', 'header.navbar', '.navbar', '#header-placeholder'];
        (async function attachHeaderHelpers() {
          let header = null;
          for (const sel of headerSelectors) {
            try {
              header = await waitFor(sel, 2500);
              if (header) break;
            } catch (e) { /* ignore and continue */ }
          }

          // fallback: if header-placeholder exists but the real header hasn't been injected, try to use placeholder element
          if (!header) header = document.getElementById('header-placeholder') || document.querySelector('header');

          if (!header) {
            // nothing to attach to - nothing to do
            return;
          }

          // Try to find nav inside header
          const nav = header.querySelector('.nav') || header.querySelector('nav');
          // If nav is not found, we still add a mobile button to header placeholder (safe)
          // Inject a mobile menu button if one doesn't exist already
          let mobileBtn = header.querySelector('.mobile-menu-btn') || document.createElement('button');
          if (!header.contains(mobileBtn)) {
            mobileBtn.className = 'mobile-menu-btn';
            mobileBtn.setAttribute('aria-expanded', 'false');
            mobileBtn.setAttribute('aria-label', 'Open menu');
            mobileBtn.innerHTML = '&#9776;'; // hamburger
            // insert as first child of header's inner container if exists, else append
            const insertBefore = header.querySelector('.nav-inner') || header.querySelector('.brand') || header;
            try { insertBefore.insertBefore(mobileBtn, insertBefore.firstChild); } catch (e) { header.insertBefore(mobileBtn, header.firstChild); }
          }

          // toggle function
          function toggleNav() {
            if (!nav) return;
            const open = nav.classList.toggle('mobile-open');
            mobileBtn.setAttribute('aria-expanded', open ? 'true' : 'false');
            // if opening, ensure it's on top
            if (open) { nav.focus && nav.focus(); }
          }

          // attach click
          mobileBtn.addEventListener('click', function (e) {
            e.stopPropagation();
            toggleNav();
          });

          // close nav when clicking outside
          document.addEventListener('click', function (e) {
            if (!nav || !nav.classList.contains('mobile-open')) return;
            if (!nav.contains(e.target) && !mobileBtn.contains(e.target)) nav.classList.remove('mobile-open');
          });

          // Make hover-only submenus work on touch:
          // detect touch devices
          const isTouch = ('ontouchstart' in window) || navigator.maxTouchPoints > 0;
          if (isTouch && nav) {
            // convert ".has-submenu" items (common pattern) - toggle on first tap
            nav.querySelectorAll('.has-submenu, .has-dropdown, .has-subnav').forEach(function (parent) {
              // add a toggle button if not present to make it accessible
              if (!parent.querySelector('.submenu-toggle')) {
                const link = parent.querySelector('a');
                const btn = document.createElement('button');
                btn.className = 'submenu-toggle';
                btn.setAttribute('aria-expanded', 'false');
                btn.style.marginLeft = '8px';
                btn.style.background = 'transparent';
                btn.style.border = 'none';
                btn.style.color = 'inherit';
                btn.style.fontSize = '18px';
                btn.innerHTML = '▾';
                // append toggle after the link (if exists)
                if (link && link.parentNode) link.parentNode.insertBefore(btn, link.nextSibling);
                btn.addEventListener('click', function (ev) {
                  ev.preventDefault();
                  ev.stopPropagation();
                  const open = parent.classList.toggle('submenu-open');
                  btn.setAttribute('aria-expanded', open ? 'true' : 'false');
                });
              }
            });

            // close submenus when tapping outside
            document.addEventListener('touchstart', function (ev) {
              document.querySelectorAll('.submenu-open').forEach(function (el) {
                if (!el.contains(ev.target)) el.classList.remove('submenu-open');
              });
            }, {passive:true});
          }

        })(); // attachHeaderHelpers()
      }); // DOMContentLoaded
    })();
  </script>

  <!-- Viewer init script (robust, logs errors & forces mesh addition) -->
  <script>
    (function () {
      document.addEventListener('DOMContentLoaded', async () => {
        const container = document.getElementById('ifc-viewer-container');
        if (!container) {
          console.error('IFC viewer container (#ifc-viewer-container) not found.');
          return;
        }

        // Ensure library loaded
        if (!window.IfcViewerAPI) {
          console.error('IfcViewerAPI not found. Make sure web-ifc-viewer script is included before this script.');
          return;
        }

        // Create viewer instance and expose for console debugging
        window.viewer = new window.IfcViewerAPI({ container, backgroundColor: 0x101010 });
        console.log('IfcViewerAPI created:', !!window.viewer);

        // Set WASM path (CDN for quick testing).
        // For production you should host web-ifc.wasm on your origin and set the folder path.
        try {
          await window.viewer.IFC.setWasmPath('https://unpkg.com/web-ifc@0.0.134/');
          console.log('web-ifc.wasm path set (CDN).');
        } catch (err) {
          console.error('Failed to set wasm path or download wasm from CDN. Error:', err);
          alert('IFC viewer could not initialise: wasm load failed. Check console.');
          return;
        }

        // Renderer tweaks
        try {
          window.viewer.context.renderer.postproduction.active = true;
          window.viewer.context.renderer.postproduction.bloomStrength = 0.12;
          window.viewer.context.renderer.postproduction.bloomRadius = 0.45;
        } catch (e) { /* ignore if not available */ }

        let loadedModel = null;

        async function clearModel() {
          try {
            if (!loadedModel) return;
            if (loadedModel.modelID !== undefined) {
              window.viewer.scene.removeModel(loadedModel.modelID);
            } else if (loadedModel.mesh) {
              window.viewer.context.getScene().remove(loadedModel.mesh);
            }
          } catch (e) {
            console.warn('Error clearing previous model', e);
          }
          loadedModel = null;
        }

        async function loadFromUrl(url) {
          try {
            console.log('Loading IFC from URL:', url);
            await clearModel();
            const model = await window.viewer.IFC.loadIfcUrl(url, {
              onProgress: (ev) => { console.log('URL load progress:', ev); }
            });
            console.log('Loaded model object:', model);
            loadedModel = model;

            // Add mesh explicitly if present
            if (model.mesh && !window.viewer.context.getScene().children.includes(model.mesh)) {
              window.viewer.context.getScene().add(model.mesh);
              console.log('Model mesh added to scene.');
            }

            try { window.viewer.fitToFrame(); } catch(e) { console.warn('fitToFrame failed', e); }
          } catch (err) {
            console.error('Error loading IFC from URL:', err);
            alert('Could not load IFC from URL. Check console for details (CORS/404/wasm).');
          }
        }

        async function loadFromFile(file) {
          try {
            if (!file) {
              console.warn('No file provided to loadFromFile.');
              return;
            }
            console.log('Loading local file:', file.name, file.size, 'bytes');
            await clearModel();
            const url = URL.createObjectURL(file);
            try {
              const model = await window.viewer.IFC.loadIfcUrl(url, {
                onProgress: (ev) => { console.log('File load progress:', ev); }
              });
              console.log('Local model loaded:', model);
              loadedModel = model;

              if (model.mesh && !window.viewer.context.getScene().children.includes(model.mesh)) {
                window.viewer.context.getScene().add(model.mesh);
                console.log('Local model mesh added to scene.');
              }
              try { window.viewer.fitToFrame(); } catch(e) { console.warn('fitToFrame failed', e); }
            } finally {
              setTimeout(() => URL.revokeObjectURL(url), 2000);
            }
          } catch (err) {
            console.error('Error loading local IFC file:', err);
            alert('Failed to load local IFC — see console for details.');
          }
        }

        // wire UI
        const fileInput = document.getElementById('ifcFileInput');
        const urlInput = document.getElementById('ifcUrlInput');
        const loadUrlBtn = document.getElementById('ifcLoadUrlBtn');
        const fitBtn = document.getElementById('ifcFitBtn');
        const wireBtn = document.getElementById('ifcWireBtn');
        const bgBtn = document.getElementById('ifcBgBtn');

        if (fileInput) {
          fileInput.addEventListener('change', (ev) => {
            const f = ev.target.files && ev.target.files[0];
            if (f) loadFromFile(f);
          });
        } else {
          console.warn('file input (#ifcFileInput) not found.');
        }

        if (loadUrlBtn && urlInput) {
          loadUrlBtn.addEventListener('click', () => {
            const u = (urlInput.value || '').trim();
            if (!u) { alert('Paste an IFC file URL then press Load'); return; }

            // Try a HEAD first to detect CORS/404 quickly then load
            fetch(u, { method: 'HEAD' })
              .then(r => {
                console.log('HEAD status for', u, r.status, r.headers.get('content-type'));
                loadFromUrl(u);
              })
              .catch(err => {
                console.warn('HEAD request failed; attempting load anyway (likely CORS). Error:', err);
                loadFromUrl(u);
              });
          });
        }

        if (fitBtn) fitBtn.addEventListener('click', () => { try { window.viewer.fitToFrame(); } catch(e){ console.warn(e); } });

        let edgesShown = false;
        if (wireBtn) wireBtn.addEventListener('click', () => {
          edgesShown = !edgesShown;
          if (!loadedModel) return console.warn('No model loaded to toggle edges.');
          if (edgesShown) window.viewer.edges.renderEdges(loadedModel.modelID);
          else window.viewer.edges.removeAll();
        });

        if (bgBtn) bgBtn.addEventListener('click', () => {
          try {
            const scene = window.viewer.context.getScene();
            const current = scene.background;
            const dark = current && current.equals && current.equals(new THREE.Color(0x101010));
            scene.background = new THREE.Color(dark ? 0xffffff : 0x101010);
          } catch(e) { console.warn('toggle bg failed', e); }
        });

        // expose loaded model for debugging
        window._ifcLoadedModel = () => loadedModel;

        console.log('IFC viewer ready. Use the file control or paste an IFC URL to load a model.');
      });
    })();
  </script>

  <!-- START: Automatic theme toggle script (do not remove) -->
  <script>
  (function(){
    // Key used to store user preference. If null → follow system preference (auto).
    const STORAGE_KEY = 'aqj_theme_pref';

    // Apply theme: set data-theme and several class names for compatibility
    function applyTheme(theme) {
      document.documentElement.setAttribute('data-theme', theme);
      // remove any old theme classes
      document.documentElement.classList.remove('dark', 'light', 'dark-theme', 'light-theme');
      if (theme === 'dark') {
        document.documentElement.classList.add('dark', 'dark-theme');
      } else {
        document.documentElement.classList.add('light', 'light-theme');
      }
    }

    // Read saved preference (if any). Valid values: "dark", "light", or null (auto).
    const saved = (function(){
      try { return localStorage.getItem(STORAGE_KEY); } catch(e) { return null; }
    })();

    // System preference media query
    const mq = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)');

    // Decide initial theme: saved → use saved; otherwise follow system
    const initial = saved === 'dark' || saved === 'light' ? saved : (mq && mq.matches ? 'dark' : 'light');
    applyTheme(initial);

    // If user has no saved preference, listen to system preference changes and update automatically.
    if (!saved && mq && typeof mq.addEventListener === 'function') {
      mq.addEventListener('change', (e) => {
        applyTheme(e.matches ? 'dark' : 'light');
      });
    } else if (!saved && mq && typeof mq.addListener === 'function') {
      // fallback for older browsers
      mq.addListener((e) => {
        applyTheme(e.matches ? 'dark' : 'light');
      });
    }

    // Expose a setter so existing UI toggle code can call window.setTheme('dark'|'light'|'auto')
    // - 'dark'   : force dark theme and save preference
    // - 'light'  : force light theme and save preference
    // - 'auto'   : remove saved preference and follow system preference
    window.setTheme = function(theme) {
      try {
        if (theme === 'dark' || theme === 'light') {
          localStorage.setItem(STORAGE_KEY, theme);
          applyTheme(theme);
        } else {
          // 'auto' or unknown → remove stored preference and follow system immediately
          localStorage.removeItem(STORAGE_KEY);
          const sys = mq && mq.matches ? 'dark' : 'light';
          applyTheme(sys);
        }
      } catch (e) {
        // storage might be blocked; still apply theme without saving
        const sys = theme === 'dark' ? 'dark' : (theme === 'light' ? 'light' : (mq && mq.matches ? 'dark' : 'light'));
        applyTheme(sys);
      }
    };

    // Attach delegated click listener for elements with data-theme-toggle attribute
    try {
      document.addEventListener('click', function (ev) {
        const btn = ev.target && (ev.target.closest ? ev.target.closest('[data-theme-toggle]') : null);
        if (!btn) return;
        ev.preventDefault();
        const mode = btn.getAttribute('data-theme-toggle') || 'toggle'; // 'dark'|'light'|'auto'|'toggle'
        if (mode === 'toggle') {
          const current = (document.documentElement.getAttribute('data-theme') === 'dark') ? 'dark' : 'light';
          window.setTheme(current === 'dark' ? 'light' : 'dark');
        } else {
          window.setTheme(mode);
        }
      }, { passive: true });
    } catch (e) { /* ignore */ }

  })();
  </script>
  <!-- END: Automatic theme toggle script -->

</body>
</html>
